name: Monitoring

on:
  push:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Run every 6 hours

env:
  NEXT_PUBLIC_INFURA_KEY: ${{ secrets.NEXT_PUBLIC_INFURA_KEY }}
  NOVA_MONITOR_RPC_URL: ${{ secrets.NOVA_MONITOR_RPC_URL }}
  ARB_ONE_MONITOR_RPC_URL: ${{ secrets.ARB_ONE_MONITOR_RPC_URL }}
  NODE_ENV: "CI"

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repositories
      uses: actions/checkout@v4
      with:
        repository: OffchainLabs/arbitrum-token-bridge

    - name: Install node_modules
      uses: OffchainLabs/actions/node-modules/install@main

    - name: Checkout Arbitrum Monitoring repository
      uses: actions/checkout@v4
      with:
        repository: OffchainLabs/arbitrum-monitoring
        path: arbitrum-monitoring

    - name: Setup Node and install dependencies
      uses: actions/setup-node@v4
      with:
        node-version: latest
    - run: cd ./arbitrum-monitoring && yarn install

    - name: Cache Arbitrum Monitoring setup
      uses: actions/cache@v2
      with:
        path: |
          ./arbitrum-monitoring
          ./node_modules
        key: ${{ runner.os }}-arbitrum-monitoring-${{ hashFiles('**/yarn.lock') }}

  run-monitoring:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chain: [core, orbit]
        monitor: [assertion, batch-poster, retryable]
    steps:
    - name: Restore cached Arbitrum Monitoring setup
      uses: actions/cache@v2
      with:
        path: |
          ./arbitrum-monitoring
          ./node_modules
        key: ${{ runner.os }}-arbitrum-monitoring-${{ hashFiles('**/yarn.lock') }}

    - name: Load configuration
      id: config
      run: |
        CONFIG=$(cat .github/workflows/monitor-config.json | jq -r '.${{ matrix.chain }}')
        echo "generate_command=$(echo $CONFIG | jq -r '.generateCommand')" >> $GITHUB_OUTPUT
        echo "config_file=$(echo $CONFIG | jq -r '.configFile')" >> $GITHUB_OUTPUT
        echo "slack_token=$(echo $CONFIG | jq -r '.slackTokens.${{ matrix.monitor }}')" >> $GITHUB_OUTPUT
        echo "slack_channel=$(echo $CONFIG | jq -r '.slackChannels.${{ matrix.monitor }}')" >> $GITHUB_OUTPUT

    - name: Generate chains JSON
      run: yarn workspace arb-token-bridge-ui ${{ steps.config.outputs.generate_command }}
      env:
        BATCH_POSTER_MONITORING: ${{ matrix.monitor == 'batch-poster' }}

    - name: Copy chains JSON to Arbitrum Monitoring
      run: cp ./packages/arb-token-bridge-ui/public/${{ steps.config.outputs.config_file }} ./arbitrum-monitoring/packages/${{ matrix.monitor }}-monitor/config.json

    - name: Run monitoring command
      run: cd ./arbitrum-monitoring && yarn ${{ matrix.monitor }}-monitor --enableAlerting
      env:
        SLACK_TOKEN: ${{ secrets[steps.config.outputs.slack_token] }}
        SLACK_CHANNEL: ${{ secrets[steps.config.outputs.slack_channel] }}

    - name: Clean up
      run: rm ./packages/arb-token-bridge-ui/public/${{ steps.config.outputs.config_file }}
