name: Orbit Retryable Tracker

on:
  schedule:
    # Run everyday at 12:00 PM UTC
    - cron: '0 12 * * *'

env:
  NEXT_PUBLIC_INFURA_KEY: ${{ secrets.NEXT_PUBLIC_INFURA_KEY }}

jobs:
  run-alerting:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Bridge repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: yarn install

    - name: Generate chains JSON
      run: yarn workspace arb-token-bridge-ui generateOrbitChainsToMonitor

    - name: Checkout Orbit-Retryable-Tracker repository
      uses: actions/checkout@v2
      with:
        repository: https://github.com/OffchainLabs/orbit-retryable-tracker/tree/enable-alerting
        path: orbit-retryable-tracker

    - name: Copy chains JSON to Retryable-Tracker
      run: cp chains.jsonorbit-retryable-tracker/lib/config.json

    - name: Set up Node.js
      working-directory: orbit-retryable-tracker
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies for Retryable-Tracker
      working-directory: orbit-retryable-tracker
      run: yarn install

    - name: Run alerting command
      working-directory: orbit-retryable-tracker
      run: yarn findRetryables --continuous --enableAlerting
      env:
        NODE_ENV: "CI"
        SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
        SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}


    - name: Clean up
      run: rm chains.json
